
{{? at.headerScripts }}

    <link href="style.css" rel="stylesheet" type="text/css" />

{{?? at.bodyAttributes }}

    x-widget="{{=at.view.widget.body}}"

{{?? at.footerScripts }}

    <!--
        Global UI API
    -->
    <script>
        window.API = {
            helpers: null,
            load: {
                static: null
            },
            config: {{=at.config}}
        };
    </script>


    <!--
        Our static resource container
    -->
    <script src="/lib/require.js"></script>
    <script src="/lib/require-loader.js"></script>
    <script>
        window.API.load.static = io_pinf_server_requirejs.load;
    </script>


    <!--
        Boot UI
    -->
    <script>

        /**
         * UI Helpers
         */
        window.API.load.static("helpers", function(err, HELPERS) {
            if (err) {
                console.error(err);
                return;
            }

            window.API.helpers = HELPERS;

            var Q = window.API.helpers.API.Q;

            var views = Q.denodeify()

            /**
             * Views
             */
            var views = Q.nbind(window.API.load.static, null)("sammy").then(function(SAMMY) {
                var sammy = null;
                return Q.denodeify(function (callback) {
                    sammy = SAMMY(function() {
                        return HELPERS.getViews().then(function(views) {
                            var activeView = null;
                            var latestWidgets = [];
                            Object.keys(views).forEach(function(routeExpr) {
                                var view = views[routeExpr];
                                var route = routeExpr;
                                if (/^\/.+\/$/.test(routeExpr)) {
                                    routeExpr = new RegExp(route.replace(/(^\/|\/$)/g, ""));
                                    route = view.link;
                                }
                                console.log("Register view", route, view);
                                if (view.aspects) {
                                    if (view.aspects["sidebar-menu-container"]) {
                                        var html = [];
                                        html.push('<li>');
                                        html.push('<a href="' + route + '">');
                                        html.push('<i class="fa ' + view.aspects["sidebar-menu-container"].style + '"></i> <span>' + view.aspects["sidebar-menu-container"].label + '</span>');
                                        html.push('</a>');
                                        html.push('</li>');
                                        $(html.join("")).appendTo($("#sidebar-menu-container"));
                                    }
                                }
                                return sammy.get(routeExpr, function() {
                                    if (activeView === route) {
                                        // If view has not changed we don't reload it.
                                        // TODO: Optionally force-reload view.
                                        return;
                                    }
                                    activeView = route;
                                    console.log("Show view", route, view);
                                    if (latestWidgets) {
                                        while (latestWidgets.length > 0) {
                                            latestWidgets.shift().destroy();
                                        }
                                    }
                                    return HELPERS.renderWidgetIntoDomId("view-content-container", view.widget).then(function (widgets) {
                                        widgets.reverse();
                                        latestWidgets = latestWidgets.concat(widgets);
                                    });
                                });
                            });
                            return callback(null);
                        }).fail(callback);
                    });
                })().then(function() {
                    return sammy;
                });
            }).fail(function(err) {
                console.error(err);                
            });

            /**
             * Components
             */
            var components = Q.nbind(window.API.load.static, null)("firewidgets").then(function(firewidgets) {
                var firewidgetsHost = window.location.host.replace(/^io-pinf-ui/, "io-pinf-server-firewidgets");
                firewidgets.setAPI(window.API.helpers.API);
                return firewidgets.init({
                    widgetBaseUri: "//" + firewidgetsHost + "/widget",
                    serviceBaseUri: "//" + firewidgetsHost + "/service"
                });
            });

            return Q.spread([
                views,
                components
            ], function(views, components) {
                views.run("#/");
            }).fail(function(err) {
                console.error(err);
            });
        });
    </script>

{{?}}
