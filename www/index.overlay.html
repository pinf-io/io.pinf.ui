
{{? at.headerScripts }}

    <link href="style.css" rel="stylesheet" type="text/css" />

{{?? at.bodyAttributes }}

    x-widget="{{=at.view.widget.body}}"

{{?? at.footerScripts }}

    <!--
        Global UI API
    -->
    <script>
        window.API = {
            helpers: null,
            load: {
                static: null
            },
            config: {{=at.config}}
        };
    </script>


    <!--
        Our static resource container
    -->
    <script src="/lib/require.js"></script>
    <script src="/lib/require-loader.js"></script>
    <script>
        window.API.load.static = io_pinf_server_requirejs.load;
    </script>


    <!--
        Boot UI
    -->
    <script>

        /**
         * UI Helpers
         */
        window.API.load.static("helpers", function(err, HELPERS) {
            if (err) {
                console.error(err);
                return;
            }

            window.API.helpers = HELPERS;

            var Q = window.API.helpers.API.Q;

            var views = Q.denodeify()

            /**
             * Views
             */
            var views = Q.nbind(window.API.load.static, null)("sammy").then(function(SAMMY) {
                var sammy = null;
                return Q.denodeify(function (callback) {
                    sammy = SAMMY(function() {
                        return HELPERS.getViews().then(function(views) {
                            var latestWidgets = [];
                            Object.keys(views).forEach(function(route) {
                                var view = views[route];
                                console.log("Register view", route, view);
                                return sammy.get(route, function() {
                                    console.log("Show view", route, view);
                                    if (latestWidgets) {
                                        while (latestWidgets.length > 0) {
                                            latestWidgets.shift().destroy();
                                        }
                                    }
                                    return HELPERS.renderWidgetIntoDomId("view-content-container", view.widget).then(function (widgets) {
                                        widgets.reverse();
                                        latestWidgets = latestWidgets.concat(widgets);
                                    });
                                });
                            });
                            return callback(null);
                        }).fail(callback);
                    });
                })().then(function() {
                    return sammy;
                });
            }).fail(function(err) {
                console.error(err);                
            });

            /**
             * Components
             */
            var components = Q.nbind(window.API.load.static, null)("firewidgets").then(function(firewidgets) {

                var firewidgetsHost = window.location.host.replace(/^io-pinf-ui/, "io-pinf-server-firewidgets");

                return firewidgets.init({
                    widgetBaseUri: "//" + firewidgetsHost + "/widget",
                    serviceBaseUri: "//" + firewidgetsHost + "/service"
                });
            });

            return Q.spread([
                views,
                components
            ], function(views, components) {
                views.run("#/");
            });
        });
    </script>

{{?}}
